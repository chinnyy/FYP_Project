---
title: "Q1_Laby_rmd_ver"
author: "Faith"
date: "2023-02-03"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cosmo
    collapsed: true
    smooth_scroll: true
  editor_options: 
    markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE) 
# hides messages & warnings
```

## Setup
Load packages & plot setup

```{r echo=TRUE}
wd<- setwd("C:/Users/chiny/Desktop/FYP/R") 

library(plyr) # data wrangling
library(dplyr) # data wrangling
library(tidyverse) # data wrangling and management
library(ggplot2) # visualization
library(phyloseq) # metabarcoding
library(ape) # phylogentic tree creation 
library(cluster) # Find clusters in data
library(vegan) # Ecological statistic tools 
library(tabula) # Tests and measures of diversity
library(goeveg) # NMDS screeplot
library(scatterpie) # Scatterpie plot
library(smplot2) # Statistical data visualization that complements ggplot2
library(gridExtra) # Extensions to the grid system in ggplot2
library(treemapify) # Extensions to create treemaps in ggplot2
library(viridis) # Colourblind friendly map

# Create base map
worldmap <- map_data ("world")# From the tidyverse package

base_world  <- ggplot()+ 
  coord_fixed() +
  xlab("") + ylab("") + 
  geom_polygon(data=worldmap, aes(x=long, y=lat, group=group), 
               colour="dark green", fill="light green")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_rect(fill = 'light blue', colour = 'light blue'), 
        axis.line = element_line(colour = "white"), #legend.position="none",
        axis.ticks=element_blank(), axis.text.x=element_blank(),
        axis.text.y=element_blank())

```


## Part 1:  Global abundance map of Laby and Laby vs other protists

### Global abundance map of Laby

#### Preparing laby abundance data
```{r echo=TRUE}
## Load dataset
asv_sample_wide<-read.table(file = paste0(wd,'/DATA/ALL/metapr2_ASVs_selected_abundance_Eukaryota.tsv'), sep = '\t', header = TRUE)

## Filling in the gap for climate variable
## Noted: I will be dropping the variable ecosystem_climate as it is extremely similar to climate
asv_sample_wide <- mutate(asv_sample_wide, climate = case_when((latitude <= 90 & latitude > 66.5) ~ "polar",
                                                               (latitude >= -90 & latitude < -66.5) ~ "polar",
                                                               (latitude <= 66.5 & latitude > 23.5) ~ "temperate",
                                                               (latitude >= -66.5 & latitude < -23.5) ~ "temperate",
                                                               (latitude <= 23.5 & latitude >= -23.5) ~ "equatorial")) 
  

# Filter for class laby 
laby_asv_wide <- filter(asv_sample_wide,class == "Labyrinthulomycetes")

# Preparing laby data: abundance within class
laby_order <- laby_asv_wide %>%
  group_by(latitude,longitude,order,n_reads) %>%
  dplyr::summarise(total_count=n()*n_reads,.groups = 'drop')%>% # Find the total count for each location 
  select( -n_reads) %>% group_by(latitude,longitude,order)%>%
  dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same location
  spread(key = order, value = total_count)%>% # Convert to wide data
  replace(is.na(.), 0) %>%
  mutate(sum = rowSums(select(., -c(1,2))))%>% # Add another row that counts the abundance of all 
  as.data.frame()
```

#### Plotting abundance map of laby only
```{r echo=TRUE, fig.align="center", fig.cap = "Fig 1: Global abundnace map of marine Labyrinthulomycetes",fig.width = 10, fig.asp = .62}
base_world+
  geom_point(data=laby_order, 
             aes(x=longitude, y=latitude, 
                 colour =log(sum),  # Edit out the log() if you dont want a logged version
                 fill =log(sum)), 
             pch=21, alpha=I(0.7),size=3 )+
  scale_color_viridis_c()+
  scale_fill_viridis_c()

```


### Scatterpie of Laby vs other protists

#### Preparing laby vs protist data: abundance with other class
```{r echo=TRUE}
# Kingdom level
laby_euk<- asv_sample_wide %>%
  group_by(latitude,longitude,class,n_reads) %>%
  dplyr::summarise(total_count=n()*n_reads,.groups = 'drop')%>% # Find the total count for each location 
  select( -n_reads) %>% group_by(latitude,longitude,class)%>%
  dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same location
  mutate(class = replace(class, class != "Labyrinthulomycetes", "Not Labyrinthulomycetes"))%>%
  group_by(latitude,longitude,class)%>%
  dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same location
  spread(key = class, value = total_count)%>% # Convert to wide data
  replace(is.na(.), 0) %>% 
  mutate(sum = rowSums(select(., -c(1,2))))%>% # Add another row that counts the abundance of all 
  as.data.frame()

# Supergroup Level
laby_stram<- asv_sample_wide %>%
  filter(supergroup == "Stramenopiles")%>%
 group_by(latitude,longitude,class,n_reads) %>%
 dplyr::summarise(total_count=n()*n_reads,.groups = 'drop')%>% # Find the total count for each location 
  select( -n_reads) %>% group_by(latitude,longitude,class)%>%
  dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same location
  mutate(class = replace(class, class != "Labyrinthulomycetes", "Not Labyrinthulomycetes"))%>%
  group_by(latitude,longitude,class)%>%
  dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same location
  spread(key = class, value = total_count)%>% # Convert to wide data
  replace(is.na(.), 0) %>%
  mutate(sum = rowSums(select(., -c(1,2))))%>% # Add another row that counts the abundance of all
  as.data.frame()

# Division Level
laby_sagen<- asv_sample_wide %>%
  filter(division == "Sagenista")%>%
  group_by(latitude,longitude,class,n_reads) %>%
  dplyr::summarise(total_count=n()*n_reads,.groups = 'drop')%>% # Find the total count for each location 
  select( -n_reads) %>% group_by(latitude,longitude,class)%>%
  dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same location
  mutate(class = replace(class, class != "Labyrinthulomycetes", "Not Labyrinthulomycetes"))%>%
  group_by(latitude,longitude,class)%>%
  dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same location
  spread(key = class, value = total_count)%>% # Convert to wide data
  replace(is.na(.), 0) %>%
  mutate(sum = rowSums(select(., -c(1,2))))%>% # Add another row that counts the abundance of all
  as.data.frame()

```


#### Plotting scatterpie map of laby and other protist classes: abundance within Eukaryote Kingdom
```{r echo=TRUE, fig.align="center", fig.cap = "Fig 2: Global abundnace map of marine Labyrinthulomycetes vs all protists classes",fig.width = 10, fig.asp = .62}

base_world+
  geom_scatterpie(aes(x=longitude, y=latitude, r=log(sum)/3), 
                  data=laby_euk,cols=colnames(laby_euk[,c(3:(ncol(laby_euk)-1))]), color=NA)+
  geom_scatterpie_legend(log(laby_euk$sum)/3, x=-160, y=-55)+ 
  theme(legend.position = "bottom")+
  scale_fill_manual(values = c("#440154","#21918c"))

```


```{r echo=TRUE, fig.align="center", fig.cap = "Fig 3: Global abundnace map of marine Labyrinthulomycetes vs protists classes in Stramenopiles Supergroup",fig.width = 10, fig.asp = .62}

base_world+
  geom_scatterpie(aes(x=longitude, y=latitude, r=log(sum)/3), 
                  data=laby_stram,cols=colnames(laby_stram[,c(3:(ncol(laby_stram)-1))]), color=NA)+
  geom_scatterpie_legend(log(laby_stram$sum)/3, x=-160, y=-55)+ 
  theme(legend.position = "bottom")+
  scale_fill_manual(values = c("#440154","#21918c"))

```


```{r echo=TRUE, fig.align="center", fig.cap = "Fig 4: Global abundnace map of marine Labyrinthulomycetes vs protists classes in Sagenista Division",fig.width = 10, fig.asp = .62}

base_world+
  geom_scatterpie(aes(x=longitude, y=latitude, r=log(sum)/3), 
                  data=laby_sagen,cols=colnames(laby_sagen[,c(3:(ncol(laby_sagen)-1))]), color=NA)+
  geom_scatterpie_legend(log(laby_sagen$sum)/3, x=-160, y=-55)+ 
  theme(legend.position = "bottom")+
  scale_fill_manual(values = c("#440154","#21918c"))

```


## Part 2: Co-occurrence plots of Laby vs other protist classes

### METHOD 1: Find the top 10 most abundant classes within the kingdom of eukaryotes and find the correlation

#### Preparing data
```{r echo=TRUE}
# Find the top 10 most abundant classes within the kingdom of eukaryotes

Euk_ordered<- asv_sample_wide %>%
  group_by(latitude,longitude,class,n_reads) %>%
  dplyr::summarise(total_count=n()*n_reads,.groups = 'drop')%>% # Find the total count for each location 
  select( -n_reads) %>% group_by(latitude,longitude,class)%>%
  dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same location
  group_by(class)%>%
  dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same class
  arrange(desc(total_count))%>%
  slice(1:10)%>%
  as.data.frame()

Laby_10_euk_name <- Euk_ordered %>% 
  rows_insert(data.frame(class = "Labyrinthulomycetes", total_count = 1))

# Count total count of each class under each sampling occurrence (label+evi factors)

laby_10_euk_label_wide <- asv_sample_wide %>%
  filter(class %in% Laby_10_euk_name[,1])%>%
  group_by(label,date,depth_level,depth,substrate,latitude,longitude,climate,temperature,salinity,ice_coverage,region,ecosystem,ecosystem_climate,substrate_type,class,n_reads) %>% 
  dplyr::summarise(total_count=n()*n_reads,.groups = 'drop')%>% # Find the total count for each label 
  select( -n_reads) %>% group_by(label,date,depth_level,depth,substrate,latitude,longitude,climate,temperature,salinity,ice_coverage,region,ecosystem,ecosystem_climate,substrate_type,class)%>%
  dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same class
  spread(key = class, value = total_count)%>% # Convert to wide data
  replace(is.na(.), 0) %>%
  as.data.frame()

```


####  Plotting statistics from a paired correlation
```{r echo=TRUE, fig.align="center", fig.cap = "Fig 5: Correlation plot of Labyrinthulomycetes and the top 10 most abundant protist classes",fig.width = 10, fig.asp = .62}
m1_cor_plot_laby_vs_10_euk = list()

for (i in Euk_ordered[,1]) {
  plot<- ggplot(data = laby_10_euk_label_wide, mapping = aes(x = Labyrinthulomycetes,
                                                           y = laby_10_euk_label_wide[,i])) +
    geom_point( color = '#440154', size = 1) +
    sm_statCorr(corr_method = 'spearman',
                fit.params = list(linetype = 'dashed'),
                borders = FALSE)+
    ggtitle(paste("Correlation plot of ",i))+
    labs(y= i, x = "Labyrinthulomycetes")+
    theme(plot.title = element_text(hjust = 0.5))
  m1_cor_plot_laby_vs_10_euk[[i]] <- ggplot_gtable(ggplot_build(plot))
}

do.call("grid.arrange", c(m1_cor_plot_laby_vs_10_euk, ncol=3))## display plot

```

### METHOD 2: Find the correlation between classes within the kingdom of eukaryotes and laby and find the top 10 R scores

#### Preparing data
```{r echo=TRUE}
# Count total count of each class under each sampling occurrence (label+evi factors)
laby_all_euk_label_wide <- asv_sample_wide %>%
  group_by(label,date,depth_level,depth,substrate,latitude,longitude,climate,temperature,salinity,ice_coverage,region,ecosystem,ecosystem_climate,substrate_type,class,n_reads) %>% 
  dplyr::summarise(total_count=n()*n_reads,.groups = 'drop')%>% # Find the total count for each label 
  select( -n_reads) %>% group_by(label,date,depth_level,depth,substrate,latitude,longitude,climate,temperature,salinity,ice_coverage,region,ecosystem,ecosystem_climate,substrate_type,class)%>%
  dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same class
  spread(key = class, value = total_count)%>% # Convert to wide data
  replace(is.na(.), 0) %>%
  as.data.frame()

# Loop to obtain r values
cor_res_df <- data.frame() # Create empty list

all_class_name<- data.frame(name= unique(asv_sample_wide$class))%>% 
  filter(!name == "Labyrinthulomycetes")

for (i in all_class_name[,1]){
  cor_res <- cor.test(log(laby_all_euk_label_wide$Labyrinthulomycetes), log(laby_all_euk_label_wide[,i]), method = "spearman",exact=FALSE,formula = ~ x + y,alternative = "two.sided")
  cor_res_col<- cbind(class = i, r = cor_res$estimate[["rho"]],p_value = cor_res$p.value)
  cor_res_df <- rbind(cor_res_df,cor_res_col)
}

# Select top 10 R values
cor_res_df <-cor_res_df%>%
  arrange(desc(r))%>%
  slice(1:10)

```

Note this one is extremely questionable since the R value from cor.test() does not match that displayed in the plot :")

####  Plotting statistics from a paired correlation
```{r echo=TRUE, fig.align="center", fig.cap = "Fig 6: Correlation plot of Labyrinthulomycetes and top 10 protist classes with the highest R values ",fig.width = 10, fig.asp = .62}

m2_cor_plot_laby_vs_10_euk = list()
for (i in cor_res_df[,1]) {
  plot = ggplot( mapping = aes(x = log(laby_all_euk_label_wide$Labyrinthulomycetes), y = log(laby_all_euk_label_wide[,i]))) +
    geom_point( color = '#440154', size = 1) +
    sm_statCorr(corr_method = 'spearman',
                fit.params = list(linetype = 'dashed'),
                borders = FALSE,
                lm_method = lm)+
    ggtitle(paste("Correlation plot of ",i))+
    labs(y= i, x = "Labyrinthulomycetes")+
    theme(plot.title = element_text(hjust = 0.5))
  m2_cor_plot_laby_vs_10_euk[[i]] <- ggplot_gtable(ggplot_build(plot))
}

do.call("grid.arrange", c(m2_cor_plot_laby_vs_10_euk, ncol=3))## display plot
```


## Part 3: Global abundance map of exclusively class Laby

### Plotting Global abundance map of exclusively class Laby
```{r echo=TRUE, fig.align="center", fig.cap = "Fig 7: Global abundnace map of orders within the class Labyrinthulomycetes",fig.width = 10, fig.asp = .62}
# Preparing laby data: abundance within class 
laby_order_wide <- laby_asv_wide %>%
  group_by(label,latitude,longitude,date,fraction_name,depth_level,depth,substrate,climate,temperature,salinity,ice_coverage,ecosystem,order,n_reads) %>%
  dplyr::summarise(total_count=n()*n_reads,.groups = 'drop')%>% # Find the total count for each label
  select( -n_reads) %>% group_by(label,latitude,longitude,date,fraction_name,depth_level,depth,substrate,climate,temperature,salinity,ice_coverage,ecosystem,order)%>%
  dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same order
  spread(key = order, value = total_count)%>% # Convert to wide data
  replace(is.na(.), 0) %>%
  mutate(sum = rowSums(select(., 14:19)))%>% # Add another row that counts the abundance of all 
  as.data.frame()

# Plotting scatterpie map of orders in class Laby
base_world+
  geom_scatterpie(aes(x=longitude, y=latitude, r=log(sum)/2), 
                  data=laby_order_wide,cols=colnames(laby_order_wide[,c(14:(ncol(laby_order_wide)-1))]), color=NA)+
  geom_scatterpie_legend(log(laby_order_wide$sum)/2, x=-160, y=-55)+
  theme(legend.position = "bottom")+
  scale_fill_viridis_d()

```


### Treemap of environmental factors affecting abundance in class Labyrinthulomycetes
A little messy here but I thought bigger figures would look better
May consider barplot instead 
```{r echo=TRUE, fig.align="center",fig.cap=c("Fig 8:Tree maps of Labyrinthulomycetes distribution according to depth level", "Fig 9:Tree maps of Labyrinthulomycetes distribution according to sample substrate","Fig 10:Tree maps of Labyrinthulomycetes distribution according to climate","Fig 11:Tree maps of Labyrinthulomycetes distribution according to ecosystem","Fig 12:Tree maps of Labyrinthulomycetes distribution according to temperature","Fig 13:Tree maps of Labyrinthulomycetes distribution according to salinity")}

## Cut continuous variable into discrete variable
laby_order_wide$temperature<- as.factor(cut(laby_order_wide$temperature,breaks = seq(min(laby_order_wide$temperature, na.rm = TRUE), 
                                                                                     max(laby_order_wide$temperature, na.rm = TRUE), 
                                                                                     by = 5)))
laby_order_wide$salinity<- as.factor(cut(laby_order_wide$salinity,breaks = seq(min(laby_order_wide$salinity, na.rm = TRUE), 
                                                                               max(laby_order_wide$salinity, na.rm = TRUE), 
                                                                               by = 5)))

# Listing interested environmental variables 
envi_var<- data.frame(var = c("depth_level","substrate","climate","ecosystem","temperature","salinity"))

for (i in envi_var[,1]){
  # Preparing data
  laby_order_envi <- laby_order_wide %>%
    gather(.,order, total_count,14:19 , factor_key=TRUE)%>% # Converting to long data
    group_by(across(all_of(c(i,"order","total_count"))))%>%
    dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>% #Merging all data according to ecosystem
    group_by(across(all_of(c(i,"order")))) %>%
    dplyr::summarise(total_count = sum(total_count),.groups = 'drop')%>%# Merging values of the same order
    as.data.frame()
  
  # Treemap of laby
  plot<- ggplot(laby_order_envi, aes(area = total_count, fill = order, label = order)) +
    geom_treemap() +
    geom_treemap_text(colour = "white",
                      place = "centre",
                      size = 15) +
    scale_fill_viridis_d()+
    facet_wrap(~ laby_order_envi[,1])
  
  print(plot)
}
```



```{r echo=TRUE}

```


